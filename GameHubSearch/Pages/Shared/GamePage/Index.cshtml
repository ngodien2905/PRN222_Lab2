@page
@model GameHubSearch.Pages.Shared.GamePage.IndexModel

@{
    ViewData["Title"] = "Games";
}

<h1>Games</h1>

<div class="mb-3 d-flex justify-content-between">
    <form method="post" asp-page="/Shared/Logout" class="d-inline">
        <button type="submit" class="btn btn-danger">Logout</button>
    </form>

    <input id="searchBox" class="form-control w-50" placeholder="Search title / category / developer..." />
</div>

<p>
    <a asp-page="Create">Create New</a>
</p>

<table class="table">
    <thead>
        <tr>
            <th>Title</th>
            <th>Price</th>
            <th>Release Date</th>
            <th>Category</th>
            <th>Developer</th>
            <th></th>
        </tr>
    </thead>
    <tbody id="games-body">
        @foreach (var item in Model.Games)
        {
            <tr data-game-id="@item.GameId">
                <td class="title">@item.Title</td>
                <td class="price">@item.Price.ToString("0.00")</td>
                <td class="release">@item.ReleaseDate</td>
                <td class="category">@item.Category</td>
                <td class="developer">@item.Developer</td>
                <td>
                    <a asp-page="./Edit" asp-route-id="@item.GameId">Edit</a> |
                    <a asp-page="./Details" asp-route-id="@item.GameId">Details</a> |
                    <a asp-page="./Delete" asp-route-id="@item.GameId">Delete</a>
                </td>
            </tr>
        }
    </tbody>
</table>

@section Scripts {
    <!-- SignalR from unpkg -->
    <script src="~/lib/microsoft/signalr/dist/browser/signalr.min.js"></script>
    <script>
        const connection = new signalR.HubConnectionBuilder()
            .withUrl("/GameHub")
            .withAutomaticReconnect()
            .build();

        // Row deletion
        connection.on("GameDeleted", function (id) {
            const row = document.querySelector(`[data-game-id="${id}"]`);
            if (row) row.remove();
        });

        // Row update
        connection.on("GameUpdated", function (game) {
            const row = document.querySelector(`[data-game-id="${game.id}"]`);
            if (!row) return;
            row.querySelector(".title").textContent = game.title ?? "";
            row.querySelector(".price").textContent = game.price ?? "";
            row.querySelector(".release").textContent = game.releaseDate ?? "";
            if (row.querySelector(".category") && 'category' in game)
                row.querySelector(".category").textContent = game.category ?? "";
            if (row.querySelector(".developer") && 'developer' in game)
                row.querySelector(".developer").textContent = game.developer ?? "";
        });

        // Search results rendering
        connection.on("SearchResults", function (rows) {
            const tbody = document.getElementById("games-body");
            tbody.innerHTML = "";
            for (const g of rows) {
                const tr = document.createElement("tr");
                tr.setAttribute("data-game-id", g.id);
                tr.innerHTML = `
                    <td class="title">${g.title ?? ""}</td>
                    <td class="price">${g.price ?? ""}</td>
                    <td class="release">${g.releaseDate ?? ""}</td>
                    <td class="category">${g.category ?? ""}</td>
                    <td class="developer">${g.developer ?? ""}</td>
                    <td>
                        <a href="./Edit?id=${g.id}">Edit</a> |
                        <a href="./Details?id=${g.id}">Details</a> |
                        <a href="./Delete?id=${g.id}">Delete</a>
                    </td>`;
                tbody.appendChild(tr);
            }
        });

        // Debounced search input
        let timer;
        document.getElementById("searchBox").addEventListener("input", e => {
            clearTimeout(timer);
            timer = setTimeout(() => {
                connection.invoke("SearchGames", e.target.value).catch(console.error);
            }, 300);
        });

        connection.start()
            .then(() => connection.invoke("SearchGames", "")) // initial load
            .catch(console.error);
    </script>
}
